@using Inventory.ViewModels
@model SaleViewModel

<div class="modal fade" id="modalPayment" tabindex="-1" role="dialog" aria-labelledby="adminModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width:700px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminModalLongTitle">Payment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 col-lg-6">
                        <table class="width-100-percent" style="border-spacing:0 0.5em;border-collapse:separate;">
                            <tr>
                                <td><label class="control-label mb-0">Pay Type</label></td>
                                <td>@Html.DropDownList("Payment", Model.Payments.PayTypes, new { @id = "ddlPayment", @class = "form-control control-input" })</td>
                            </tr>                          
                            <tr id="trLimitedDay" class="soft-gray-background">
                                <td class="padding-10"><label class="control-label mb-0">Limited Day</label></td>
                                <td class="padding-10">@Html.DropDownList("LimitedDay", Model.Payments.LimitedDays, new { @id = "ddlLimitedDay", @class = "form-control control-input" })</td>
                            </tr>
                            <tr class="trAdvancedPay soft-gray-background">
                                <td class="padding-10"><label class="control-label mb-0">Advanced Pay</label></td>
                                <td class="padding-10"><input id="inputAdvancedPay" type="text" class="form-control control-input numberonly" /></td>
                            </tr>                                                 
                            <tr id="trPayMethod">
                                <td><label class="control-label mb-0">Pay Method</label></td>
                                <td>@Html.DropDownList("PayMethod", Model.Payments.PayMethods, new { @id = "ddlPayMethod", @class = "form-control control-input" })</td>
                            </tr>                                                                      
                            <tr id="trBankPayment" class="soft-gray-background">
                                <td class="padding-10"><label class="control-label mb-0">Bank/Pay</label></td>
                                <td class="padding-10">@Html.DropDownList("BankPayment", Model.Payments.BankPayments, new { @id = "ddlBankPayment", @class = "form-control control-input" })</td>
                            </tr>
                            <tr class="trPercent soft-gray-background">
                                <td class="padding-10"><label class="control-label mb-0">Percent</label></td>
                                <td class="padding-10"><input id="inputPercent" type="text" class="form-control control-input numberonly" maxlength="2" /></td>
                            </tr>                                      
                        </table>  
                        <div class="row">
                            <div class="col-md-8 col-lg-8">
                                <div class="form-group">
                                    <label class="control-label mb-0">Voucher Discount</label>
                                    <input id="inputVouDisAmount" type="text" class="form-control control-input numberonly" />
                                    <input id="inputVouDisPercent" type="text" class="form-control control-input numberonly" maxlength="2" />
                                </div>
                            </div>
                            <div class="col-md-4 col-lg-4 align-center"> 
                                <input id="inputHdnVouDisType" type="hidden"/>
                                <button id="btnDiscountAmount" class="discount" value="2">$</button>                                                         
                                <button id="btnDiscountPercent" class="discount-active" value="1">%</button>                                                                                  
                            </div>
                        </div>    
                        <div class="row">
                            <div class="col-md-12 col-lg-12">
                                <div class="form-group">
                                    <label class="control-label mb-0">Remark</label>
                                    <textarea id="txtRemark" class="form-control control-input"></textarea>
                                </div>
                            </div>
                        </div>                     
                    </div>
                    <div class="col-md-6 col-lg-6">
                        <table class="width-100-percent padding-10 soft-gray-background" style="border-spacing:0.5em;border-collapse:separate;">
                            <tr>
                                <td><label class="control-label mb-0">Total Items:</label></td>
                                <td><label id="lblPayTotalItem" class="control-input mb-0">0</label></td>
                            </tr>
                            <tr>
                                <td><label class="control-label mb-0">Total Pay:</label></td>
                                <td class="value-right"><div class="note"><input id="inputHdnPayTotal" type="hidden" /><label id="lblPayTotal" class="control-input mb-0">0</label></div></td>
                            </tr>
                            <tr class="trAdvancedPay">
                                <td><label class="control-label mb-0">Advanced Pay:</label></td>
                                <td class="value-right"><div class="note"><input id="inputHdnAdvancedPay" type="hidden" /><label id="lblAdvancedPay" class="control-input mb-0">0</label></div></td>
                            </tr>
                            <tr>
                                <td><label class="control-label mb-0">Voucher Discount:</label></td>
                                <td class="value-right"><div class="note"><input id="inputHdnVoucherDiscount" type="hidden" /><label id="lblVoucherDiscount" class="control-input mb-0">0</label></div></td>
                            </tr>
                            <tr>
                                <td><label class="total-amount-label mb-0">Grandtotal:</label></td>
                                <td class="value-right"><div class="note"><input id="inputHdnPayGrandtotal" type="hidden" /><label id="lblPayGrandtotal" class="total-amount-value mb-0">0</label></div></td>
                            </tr>
                            <tr class="trPercent">
                                <td><label class="control-label mb-0">Percent:</label></td>
                                <td class="value-right"><div class="note"><input id="inputHdnPercent" type="hidden" /><label id="lblPercent" class="control-input mb-0">0</label></div></td>
                            </tr>
                            <tr id="trPcntGrandtotal">
                                <td></td>
                                <td class="value-right"><div class="note"><input id="inputHdnPcntGrandtotal" type="hidden" /><label id="lblPcntGrandtotal" class="total-amount-value mb-0">0</label></div></td>
                            </tr>
                            <tr>
                                <td><label class="control-label mb-0">Paid:</label></td>
                                <td class="value-right"><input id="inputPaid" type="text" class="form-control control-input numberonly" style="text-align:right;"/></td>
                            </tr>
                            <tr>
                                <td><label class="control-label mb-0">Return Change:</label></td>
                                <td class="value-right"><div class="note"><label id="lblReturnChange" class="control-input mb-0">0</label></div></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnClose" class="btn btn-white-outline-third">Close</button>
                <button id="btnSubmit" class="btn btn-first" data-dismiss="modal" aria-label="Close">Submit</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    function initializePaymentControl() {
        showHideByPayment(1);
        showHideByPayMethod(1);
        $("#inputHdnVouDisType").val('');
        changeDiscountType(1);
        clearPaidChange();
    }

    function showHideByPayment(value) {
        clearByPayment();
        if (value == 1) {  //cash
            $("#trLimitedDay").css('display', 'none');
            $(".trAdvancedPay").css('display', 'none');
        } else if (value == 2) {  //credit
            showLoadingIcon();
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetLimitedDayAction", "Sale")',
                data: {},
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    hideLoadingIcon();
                    createLimitedDayData(response);
                    $("#trLimitedDay").show();
                    $(".trAdvancedPay").show();
                },
                failure: function (response) {
                    hideLoadingIcon();
                    alert(response.responseText);
                },
                error: function (response) {
                    hideLoadingIcon();
                    alert(response.responseText);
                }
            });
        }
    }

    function showHideByPayMethod(value) {
        clearByPayMethod();
        if (value == 1) {  //cash in hand
            $("#trBankPayment").css('display', 'none');
            $(".trPercent").css('display', 'none');
            $("#trPcntGrandtotal").css('display', 'none');
        } else if (value == 2) {  //banking
            showLoadingIcon();
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetBankPaymentAction", "Sale")',
                data: {},
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    hideLoadingIcon();
                    createBankPaymentData(response);
                    $("#trBankPayment").show();
                    $(".trPercent").show();
                    $("#trPcntGrandtotal").show();
                    let grandtotal = $("#inputHdnPayGrandtotal").val();
                    $("#lblPcntGrandtotal").text(separatedComma(parseInt(grandtotal)));
                    $("#inputHdnPcntGrandtotal").val(grandtotal);
                },
                failure: function (response) {
                    hideLoadingIcon();
                    alert(response.responseText);
                },
                error: function (response) {
                    hideLoadingIcon();
                    alert(response.responseText);
                }
            });
        }
    }

    function clearByPayment() {
        $("#inputAdvancedPay").val("");
        $("#lblAdvancedPay").text('0');
        $("#inputHdnAdvancedPay").val("");
    }

    function clearByPayMethod() {
        $("#inputPercent").val("");
        $("#lblPercent").text('0');
        $("#inputHdnPercent").val("");
        $("#lblPcntGrandtotal").text('0');
        $("#inputHdnPcntGrandtotal").val("");
    }

    $("#btnClose").click(function (e) {
        $('#modalPayment').modal('hide');
    });

    $('#ddlPayment').change(function () {
        let val = $('#ddlPayment option:selected').val();
        showHideByPayment(val);
        calcAmount();
    });

    $('#ddlPayMethod').change(function () {
        let val = $('#ddlPayMethod option:selected').val();
        showHideByPayMethod(val);
        calcAmount();
    });

    $('#inputAdvancedPay').keydown(function (event) {
        if (event.which === 13) {
            let advancedPay = $("#inputAdvancedPay").val();
            $("#lblAdvancedPay").text(separatedComma(parseInt(advancedPay)));
            $("#inputHdnAdvancedPay").val(advancedPay);
            calcAmount();
        }
    });

    $('#inputPercent').keydown(function (event) {
        if (event.which === 13) {            
            calcAmount();
        }
    });

    function getPayPercentAmt(grandtotal) {
        let percent = $("#inputPercent").val();
        if (percent == null || percent.length == 0) percent = 0;
        let percentAmt = (parseInt(grandtotal) * parseInt(percent)) / 100;
        return percentAmt;
    }

    function calcAmount() {
        let totalPay,advancedPay,voucherDiscount,grandtotal,percentAmt,percentGrandtotal;
        totalPay = $("#inputHdnPayTotal").val();
        advancedPay = $("#inputHdnAdvancedPay").val();
        voucherDiscount = $("#inputHdnVoucherDiscount").val();

        if (advancedPay == null || advancedPay.length == 0) advancedPay = 0;
        if (voucherDiscount == null || voucherDiscount.length == 0) voucherDiscount = 0;

        grandtotal = parseInt(totalPay) - (parseInt(advancedPay) + parseInt(voucherDiscount));
        $("#lblPayGrandtotal").text(separatedComma(grandtotal));
        $("#inputHdnPayGrandtotal").val(grandtotal);

        percentAmt = parseInt(getPayPercentAmt(grandtotal));
        $("#lblPercent").text(separatedComma(percentAmt));
        $("#inputHdnPercent").val(percentAmt);

        percentGrandtotal = parseInt(grandtotal) + parseInt(percentAmt);
        $("#lblPcntGrandtotal").text(separatedComma(parseInt(percentGrandtotal)));
        $("#inputHdnPcntGrandtotal").val(percentGrandtotal);
    }

    function createLimitedDayData(response) {
        let limitedDay;
        $("#ddlLimitedDay").html("");
        for (var i = 0; i < response.length; i++) {
            limitedDay += '<option value="' + response[i].LimitedDayID + '">' + response[i].LimitedDayName + '</option>';
        }
        $("#ddlLimitedDay").append(limitedDay);
    }

    function createBankPaymentData(response) {
        let bankPayment;
        $("#ddlBankPayment").html("");
        for (var i = 0; i < response.length; i++) {
            bankPayment += '<option value="' + response[i].BankPaymentID + '">' + response[i].Name + '</option>';
        }
        $("#ddlBankPayment").append(bankPayment);
    }

    function separatedComma(value) {
        let result = value.toLocaleString('en-US');
        return result;
    }

    $("#btnDiscountPercent").click(function (e) {
        let value = $(this).val();
        changeDiscountType(value);
    });

    $("#btnDiscountAmount").click(function (e) {
        let value = $(this).val();
        changeDiscountType(value);
    });

    function changeDiscountType(value) {
        let discountType = $("#inputHdnVouDisType").val();
        if (value == discountType) return;
        $("#inputVouDisAmount").val("");
        $("#inputVouDisPercent").val("");
        $("#lblVoucherDiscount").text("0");
        $("#inputHdnVoucherDiscount").val(0);
        $("#inputHdnVouDisType").val(value);
        if (value == 1) {  //by percent
            $("#btnDiscountPercent").removeClass('discount');
            $("#btnDiscountPercent").addClass('discount-active');
            $("#btnDiscountAmount").removeClass('discount-active');
            $("#btnDiscountAmount").addClass('discount');
            $("#inputVouDisPercent").show();
            $("#inputVouDisAmount").css('display', 'none');
        } else if (value == 2) {  //by amount
            $("#btnDiscountPercent").removeClass('discount-active');
            $("#btnDiscountPercent").addClass('discount');
            $("#btnDiscountAmount").removeClass('discount');
            $("#btnDiscountAmount").addClass('discount-active');
            $("#inputVouDisAmount").show();
            $("#inputVouDisPercent").css('display', 'none');
        }
        calcAmount();
    }

    $('#inputVouDisAmount').keydown(function (event) {
        if (event.which === 13) {
            let disAmount, percent;
            if ($("#inputVouDisAmount").val() == null || $("#inputVouDisAmount").val().length == 0) return;
            disAmount = $("#inputVouDisAmount").val();
            $("#lblVoucherDiscount").text(separatedComma(parseInt(disAmount)));
            $("#inputHdnVoucherDiscount").val(disAmount);
            calcAmount();
        }
    });

    $('#inputVouDisPercent').keydown(function (event) {
        if (event.which === 13) {
            let disAmount, percent;
            if ($("#inputVouDisPercent").val() == null || $("#inputVouDisPercent").val().length == 0) return;
            percent = $("#inputVouDisPercent").val();
            let totalPay = $("#inputHdnPayTotal").val();
            disAmount = (parseInt(totalPay) * parseInt(percent)) / 100;
            $("#lblVoucherDiscount").text(separatedComma(parseInt(disAmount)));
            $("#inputHdnVoucherDiscount").val(parseInt(disAmount));
            calcAmount();
        }
    });

    $('#inputPaid').keydown(function (event) {
        if (event.which === 13) {
            let grandtotal;
            let paidAmt = $("#inputPaid").val();
            if (isBankPayment == "True") {
                let val = $('#ddlPayMethod option:selected').val();
                if (val == 2) {  //banking
                    grandtotal = $("#inputHdnPcntGrandtotal").val();
                    setReturnChange(paidAmt, grandtotal);
                } else {
                    grandtotal = $("#inputHdnPayGrandtotal").val();
                    setReturnChange(paidAmt, grandtotal);
                }
            } else {
                grandtotal = $("#inputHdnPayGrandtotal").val();
                setReturnChange(paidAmt, grandtotal);
            }
        }
    });

    function setReturnChange(paidAmt, grandtotal) {
        if (paidAmt != null && paidAmt.length != 0 && grandtotal != null && grandtotal.length != 0) {
            let changeAmt = parseInt(paidAmt) - parseInt(grandtotal);
            $("#lblReturnChange").text(separatedComma(parseInt(changeAmt)));
        }
    }

    function clearPaidChange() {
        $("#inputPaid").val('');
        $("#lblReturnChange").text('');
    }

    $("#btnSubmit").click(function (e) {
        let userVoucherNo = $('#lblUserVoucherNo').text();
        let date = $('#inputDate').val();
        let voucherId = $('#inputVoucherID').val();
        let customerId = $('#ddlCustomer option:selected').val();
        let locationId = $('#ddlLocation option:selected').val();
        let paymentId = $('#ddlPayment option:selected').val();
        let payMethodId = $('#ddlPayMethod option:selected').val();
        let limitedDayId = $('#ddlLimitedDay option:selected').val();
        let bankPaymentId = $('#ddlBankPayment option:selected').val();
        let advancedPay = $('#inputHdnAdvancedPay').val();
        let payPercentAmt = $('#inputHdnPercent').val();
        let payPercent = $('#inputPercent').val();
        let voucherDiscount = $('#inputHdnVoucherDiscount').val();
        let vouDisPercent = $('#inputVouDisPercent').val();
        let vouDisAmount = $('#inputVouDisAmount').val();
        let remark = $('#txtRemark').val();
        let tax = localStorage.getItem("Tax");
        let charges = localStorage.getItem("Charges");
        let subtotal = $("#inputHdnSubtotal").val();
        let taxAmt = $("#inputHdnTax").val();
        let chargesAmt = $("#inputHdnCharges").val();
        let total = $("#inputHdnPayTotal").val();
        let grandtotal;
        if (isBankPayment == "True" && payMethodId == 2)
            grandtotal = $("#inputHdnPcntGrandtotal").val();
        else grandtotal = $("#inputHdnPayGrandtotal").val();
        let userId = localStorage.getItem("UserID");
        showLoadingIcon();
        $.ajax({
            type: "POST",
            url: '@Url.Action("PaymentSubmitAction", "Sale")',
            data: JSON.stringify({
                "userVoucherNo": userVoucherNo, "date": date, "voucherId": voucherId, "customerId": customerId, "locationId": locationId,
                "paymentId": paymentId, "payMethodId": payMethodId, "limitedDayId": limitedDayId, "bankPaymentId": bankPaymentId, "remark": remark, "advancedPay": advancedPay,
                "payPercent": payPercent, "payPercentAmt": payPercentAmt, "vouDisPercent": vouDisPercent, "vouDisAmount": vouDisAmount, "voucherDiscount": voucherDiscount,
                "tax": tax, "taxAmt": taxAmt, "charges": charges, "chargesAmt": chargesAmt, "subtotal": subtotal, "total": total, "grandtotal": grandtotal, "userId": userId
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                hideLoadingIcon();
                if (!response.IsRequestSuccess) {
                    alert("Session Expired!");
                    redirectToLogin();
                }                    
                else {
                    window.location.href = '@Url.Action("SaleVoucher", "Sale")?systemVoucherNo=' + response.SystemVoucherNo + '&locationId=' + response.LocationID;
                }
            },
            failure: function (response) {
                hideLoadingIcon();
                alert(response.responseText);
            },
            error: function (response) {
                hideLoadingIcon();
                alert(response.responseText);
            }
        });
    });

</script>
